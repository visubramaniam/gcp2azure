####################################################################
# Create a volume in the cloud storage and attach it to a compute node.
####################################################################
- name: Volume Module
  hosts: localhost
  gather_facts: false
  no_log: false
  # Removed 'collections' as FQCN will be used for all modules
  vars_files:
    - ansible_vault_storage_var.yml

  vars:
    # Common connection info for all tasks
    connection_info:
      address: "{{ az_cloud_storage_address }}"
      username: "{{ az_cloud_vault_storage_username }}"
      password: "{{ az_cloud_vault_storage_secret}}"
  tasks:
    ####################################################################
    # Task 1 : Create volume
    ####################################################################
    - name: Create and attach volume
      hitachivantara.vspone_block.sds_block.hv_sds_block_volume:
        connection_info: "{{ connection_info }}"
        state: "present"
        spec:
          name: "{{ az_cloud_vol_name }}"
          capacity: "{{ az_cloud_vol_capacity }}"
          pool_name: "{{ az_cloud_pool_name }}"
          capacity_saving: "Disabled"
          compute_nodes: ["{{ az_cloud_compute_node_name }}"]
      register: result
    - name: Debug the result variable
      ansible.builtin.debug:
        var: result
    - name: Set Volume Number for workflow
      ansible.builtin.set_stats:
        data:
          az_svol_ldev_id: "{{ result.data.volume_number }}"
    - name: Set Storage Controller ID for workflow
      ansible.builtin.set_stats:
        data:
          az_storage_controller_id: "{{ result.data.storage_controller_id }}"
